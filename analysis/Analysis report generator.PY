"""
analysis_report_generator.py - 16ê°œ ê²€ì¦ ë¶„ì„ ê²°ê³¼ ìë™ ë¦¬í¬íŠ¸ ìƒì„±

ê¸°ëŠ¥:
1. 16ê°œ ê²€ì¦ ê²°ê³¼ ë¶„ì„
2. ë©”ë‰´ì–¼ ê¸°ë°˜ ìë™ ë¦¬í¬íŠ¸ ìƒì„±
3. íƒˆë½ í•­ëª©ë³„ ê°œì„ ë°©í–¥ ì œì‹œ
4. ì•¡ì…˜ í”Œëœ ìë™ ìƒì„±
5. Markdown íŒŒì¼ ì €ì¥
"""

import pandas as pd
import numpy as np
from datetime import datetime
from typing import Dict, List, Any
import os


class AnalysisReportGenerator:
    """ë¶„ì„ ê²°ê³¼ ìë™ ë¦¬í¬íŠ¸ ìƒì„± í´ë˜ìŠ¤"""
    
    def __init__(self, comprehensive_results: Dict[str, Any], trades_df: pd.DataFrame):
        """
        ì´ˆê¸°í™”
        
        Parameters:
        -----------
        comprehensive_results : dict
            16ê°œ ê²€ì¦ ê²°ê³¼ (comprehensive.pyì—ì„œ ë°˜í™˜)
        trades_df : pd.DataFrame
            ê±°ë˜ ë°ì´í„°í”„ë ˆì„
        """
        self.results = comprehensive_results
        self.trades_df = trades_df
        self.timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        self.filename = f"ë¶„ì„ê²°ê³¼_{self.timestamp}.md"
        
        # íŒì • ê¸°ì¤€ ì„¤ì •
        self.pass_criteria = self._setup_criteria()
        
    def _setup_criteria(self) -> Dict[str, Any]:
        """í†µê³¼ ê¸°ì¤€ ì •ì˜"""
        return {
            '1-1_monthly': {'positive_months_pct': 0.5},
            '1-2_consecutive': {'max_loss_days': 7},
            '1-3_holding': {'consistency': 0.6},
            '1-4_density': {'overtrading': 'normal'},
            '1-5_equity': {'r_squared': 0.7, 'drawdown': -0.5},
            '2-1_pvalue': {'p_value': 0.05},
            '2-2_normality': {'p_value': 0.05},
            '2-3_autocorr': {'dw_range': (1.5, 2.5)},
            '2-4_distribution': {'skewness': 1.0},
            '3-1_pf': {'pf': 1.5},
            '3-2_sequence': {'randomness': 0.4},
            '4-4_capital': {'survived': True},
            '5-2_bootstrap': {'positive_prob': 0.9},
            '5-3_extreme': {'ratio': 2.0},
            '6-2_growth': {'growth_pct': 0.2},
            '6-3_regression': {'r_squared': 0.7},
            '7-1_kelly': {'kelly_range': (0.01, 0.05)},
            '7-2_var': {'var_95': 0.05},
            '7-3_sharpe': {'sharpe': 1.0},
        }
    
    # ========== PART 1: 16ê°œ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„± ==========
    def _generate_checklist(self) -> str:
        """16ê°œ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±"""
        
        disq = self.results['disqualification']
        validators = self.results['validators']
        final_score = self.results['final_score']
        
        checklist = """# PART 1ï¸âƒ£: 16ê°œ ê²€ì¦ í†µê³¼ ì¡°ê±´ ì²´í¬ë¦¬ìŠ¤íŠ¸

## ğŸ“Š ì¹´í…Œê³ ë¦¬ 1: ì‹œê³„ì—´ ë¶„ì„ (5ê°œ)

### 1-1. ì›”ë³„/ë¶„ê¸°ë³„/ì—°ë„ë³„ ì„±ê³¼ ë¶„ì„

**í†µê³¼ ì¡°ê±´:**
```
âœ… ì–‘ìˆ˜ ì›” ë¹„ìœ¨ > 50%
âœ… í‰ê·  ì›”ë³„ ìˆ˜ìµë¥  > 0%
âœ… ì›”ë³„ ìˆ˜ìµ í‘œì¤€í¸ì°¨ / í‰ê·  < 1.0
```

**ë‹¹ì‹ ì˜ ë°ì´í„°:**
"""
        
        if '1-1_monthly' in validators['timeseries']:
            monthly = validators['timeseries']['1-1_monthly']
            pos_pct = monthly.get('positive_months', 0) / monthly.get('total_months', 1)
            checklist += f"""```
â”œâ”€ ì–‘ìˆ˜ ì›”: {monthly.get('positive_months', 0)}ê°œì›”
â”œâ”€ ì†ì‹¤ ì›”: {monthly.get('negative_months', 0)}ê°œì›”
â”œâ”€ ì–‘ìˆ˜ ì›” ë¹„ìœ¨: {pos_pct*100:.1f}%
â”œâ”€ í‰ê·  ì›”ë³„ ìˆ˜ìµ: {monthly.get('avg_monthly_return', 0):.2f}%
â””â”€ ì›”ë³„ í¸ì°¨ (CV): {monthly.get('monthly_consistency', 0):.2f}
```

**íŒì •:** {'âœ… PASS' if pos_pct >= 0.5 else 'âŒ FAIL (ì–‘ìˆ˜ ì›” 50% ë¯¸ë§Œ)'}
"""
        
        checklist += """

### 1-2. ì—°ì†ì„± ë¶„ì„ (ìµœëŒ€ ì—°ì† ìŠ¹/íŒ¨)

**í†µê³¼ ì¡°ê±´:**
```
âœ… ìµœëŒ€ ì—°ì† ì†ì‹¤ ê±°ë˜ < 7ì¼
âœ… í‰ê·  ì—°ì† ì†ì‹¤ < 3ê±°ë˜
```

**ë‹¹ì‹ ì˜ ë°ì´í„°:**
"""
        
        if '1-2_consecutive' in validators['timeseries']:
            consec = validators['timeseries']['1-2_consecutive']
            checklist += f"""```
â”œâ”€ ìµœëŒ€ ì—°ì† ì†ì‹¤: {consec.get('max_consecutive_losses', 0)}ê±°ë˜
â”œâ”€ í‰ê·  ì—°ì† ì†ì‹¤: {consec.get('avg_consecutive_losses', 0):.1f}ê±°ë˜
â””â”€ ì‹¬ë¦¬ ì••ë°•ë„: {consec.get('psychological_pressure_score', 0):.1f}%
```

**íŒì •:** {'âœ… PASS' if consec.get('max_consecutive_losses', 0) < 7 else 'âŒ FAIL (ìµœëŒ€ ì—°ì† ì†ì‹¤ 7 ì´ìƒ)'}
"""
        
        return checklist
    
    # ========== PART 2: íƒˆë½ í•­ëª© ë¶„ì„ ==========
    def _generate_failure_analysis(self) -> str:
        """íƒˆë½ í•­ëª© ë¶„ì„ ë° ê°œì„ ë°©í–¥ ìƒì„±"""
        
        disq = self.results['disqualification']
        failures = disq.get('reasons', [])
        
        if not failures:
            return """# PART 2ï¸âƒ£: íƒˆë½ í•­ëª©ë³„ êµ¬ì²´ì  ê°œì„ ë°©í–¥

## âœ… ì¶•í•˜í•©ë‹ˆë‹¤!

**ëª¨ë“  ê²€ì¦ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤!** ğŸ‰

ìë™ë§¤ë§¤ë¥¼ ì¦‰ì‹œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"""
        
        analysis = f"""# PART 2ï¸âƒ£: íƒˆë½ í•­ëª©ë³„ êµ¬ì²´ì  ê°œì„ ë°©í–¥

## ğŸ˜ í˜„ì¬ ìƒí™©

```
ìµœì¢… íŒì •: {disq['status']}
ê¸°ì¤€: {disq['tier']}
íƒˆë½ í•­ëª©: {len(failures)}ê°œ
```

### íƒˆë½ ì´ìœ :
"""
        
        for i, reason in enumerate(failures, 1):
            analysis += f"\n**{i}. {reason}**\n"
        
        # íƒˆë½ í•­ëª©ë³„ ê°œì„ ë°©í–¥
        if 'ì†ì‹¤ ì›”' in failures[0] if failures else False:
            analysis += self._generate_loss_month_improvement()
        
        if 'ì›”ë³„ í¸ì°¨' in failures[0] if failures else False:
            analysis += self._generate_variance_improvement()
        
        return analysis
    
    def _generate_loss_month_improvement(self) -> str:
        """ì†ì‹¤ ì›” ê°œì„ ë°©í–¥"""
        
        monthly = self.results['validators']['timeseries'].get('1-1_monthly', {})
        loss_months = monthly.get('negative_months', 0)
        total_months = monthly.get('total_months', 1)
        
        return f"""

## âŒ íƒˆë½ 1: ì†ì‹¤ ì›” â‰¥ 3ê°œì›” ({loss_months}ê°œì›” ë°œìƒ)

### ë¬¸ì œ ë¶„ì„
```
í˜„ì¬ ìƒí™©:
â”œâ”€ ì´ {total_months}ê°œì›” ì¤‘ {loss_months}ê°œì›” ì†ì‹¤
â”œâ”€ ì–‘ìˆ˜ ì›”: {total_months - loss_months}ê°œì›”ë§Œ
â””â”€ ì‹¬ê°ë„: ğŸ”´ ë§¤ìš° ì‹¬ê°
```

### ì›ì¸ ë¶„ì„
**ì†ì‹¤ ì›”ì´ {loss_months}ê°œì›”ì¸ ì´ìœ :**

1. **ì‹ í˜¸ ì •í™•ë„ ë¶€ì¡±**
   - ê°œë³„ ê±°ë˜ëŠ” ë†’ì€ ìŠ¹ë¥ ì´ì§€ë§Œ ì›” ë‹¨ìœ„ë¡œëŠ” ë‹¤ë¦„

2. **ì‹œì¥ ì¡°ê±´ ë³€í™”**
   - íŠ¹ì • ì›”ì—ë§Œ ì‹ í˜¸ ì •í™•ë„ ì €í•˜

3. **í¬ì§€ì…˜ í¬ê¸° ë¬¸ì œ**
   - ì†ì‹¤ë‚  ë•Œ í¬ì§€ì…˜ì´ ë„ˆë¬´ ì»¸ì„ ìˆ˜ ìˆìŒ

### ê°œì„ ë°©í–¥ (5ë‹¨ê³„)

**Step 1: ì›”ë³„ ì†ì‹¤ íŒ¨í„´ ë¶„ì„**
```
â˜ ì›”ë³„ ì†ì‹¤ ì›ì¸ íŒŒì•…
â˜ íŠ¹ì • ì›” í•„í„° ì¶”ê°€ (í•´ë‹¹ ì›” ê±°ë˜ ì¶•ì†Œ)
â˜ ê³„ì ˆì„± ì§€í‘œ í™•ì¸
```

**Step 2: ì‹ í˜¸ ê°•ë„ í•„í„° ê°•í™”**
```
ì•½í•œ ì‹ í˜¸ (3ì  ë¯¸ë§Œ): âŒ ì§„ì… ê¸ˆì§€
ì¤‘ê°„ ì‹ í˜¸ (3~5ì ): âš ï¸ ì‹ ì¤‘í•˜ê²Œ
ê°•í•œ ì‹ í˜¸ (6ì  ì´ìƒ): âœ… ì§„ì…
```

**Step 3: ì›”ë³„ ì†ì‹¤ì œí•œ ì„¤ì •**
```
ì›” ì†ì‹¤ < 5%: âœ… ì •ìƒ ì§„í–‰
ì›” ì†ì‹¤ 5~10%: âš ï¸ ê±°ë˜ëŸ‰ 50% ì¶•ì†Œ
ì›” ì†ì‹¤ 10~15%: ğŸ”´ ê±°ë˜ëŸ‰ 80% ì¶•ì†Œ
ì›” ì†ì‹¤ â‰¥ 15%: â›” ê±°ë˜ ì¤‘ë‹¨
```

**Step 4: ë³€ë™ì„± í•„í„° ì¶”ê°€**
```
ê³ ë³€ë™ì„± ì›”: ê±°ë˜ëŸ‰ 50% ì¶•ì†Œ
ì €ë³€ë™ì„± ì›”: ê±°ë˜ëŸ‰ 100% ìœ ì§€
```

**Step 5: ì˜ˆìƒ ê°œì„  íš¨ê³¼**
```
ê°œì„  ì†Œìš” ì‹œê°„: 3ê°œì›”
ê°œì„  ë‚œì´ë„: ì¤‘ê°„ â­â­â­
ìš°ì„ ìˆœìœ„: 1ìˆœìœ„ ğŸ”´
```

**ê°œì„  í›„ ì˜ˆìƒ:**
- ì†ì‹¤ ì›”: {loss_months} â†’ 3ê°œì›” ì´í•˜
- ì›” í‰ê· : â†’ +2.5% ì´ìƒ
- íŒì •: âŒ NO-GO â†’ âœ… GO
"""
    
    def _generate_variance_improvement(self) -> str:
        """ì›”ë³„ í¸ì°¨ ê°œì„ ë°©í–¥"""
        
        monthly = self.results['validators']['timeseries'].get('1-1_monthly', {})
        cv = monthly.get('monthly_consistency', 0)
        
        return f"""

## âŒ íƒˆë½ 2: ì›”ë³„ í¸ì°¨ > 50% (CV={cv:.2f})

### ë¬¸ì œ ë¶„ì„
```
í˜„ì¬ ìƒí™©:
â”œâ”€ ì›”ë³„ ë³€ë™ê³„ìˆ˜ (CV): {cv:.2f}
â”œâ”€ ì •ìƒ ë²”ìœ„: CV < 0.5
â””â”€ ì‹¬ê°ë„: ğŸ”´ ë¶ˆì•ˆì •
```

### ì›ì¸ ë¶„ì„
```
ë†’ì€ CVì˜ ì›ì¸:

1ï¸âƒ£ ì›”ë³„ ìˆ˜ìµì´ ë¶ˆê·œì¹™
   ì˜ˆ: +10%, -5%, +2%, -8%, +15%, ...

2ï¸âƒ£ í° ì†ì‹¤ì´ ë°œìƒ
   ì˜ˆ: íŠ¹ì • ì›”ì— -15% ì†ì‹¤

3ï¸âƒ£ í° ìˆ˜ìµë„ ë°œìƒ
   ì˜ˆ: íŠ¹ì • ì›”ì— +20% ìˆ˜ìµ

â†’ ê²°ê³¼: ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ì›”ë³„ ìˆ˜ìµ
```

### ê°œì„ ë°©í–¥ (4ë‹¨ê³„)

**Step 1: ì›”ë³„ ìˆ˜ìµ ì •ê·œí™”**
```
ëª©í‘œ: CVë¥¼ {cv:.2f} â†’ 0.7ë¡œ ê°œì„ 

ì „ëµ:
â”œâ”€ í° ìˆ˜ìµì´ ë‚˜ëŠ” ì›” â†’ ê±°ë˜ëŸ‰ ì¶•ì†Œ
â”œâ”€ ì†ì‹¤ì´ ë‚˜ëŠ” ì›” â†’ ì‹ í˜¸ ê°•í™”
â””â”€ ëª©í‘œ: ì›”ë³„ ìˆ˜ìµì„ Â±5% ë²”ìœ„ë¡œ ì œí•œ
```

**Step 2: ì›”ë³„ ì´ìµ ëª©í‘œ ì„¤ì •**
```
Hard Target:
â”œâ”€ ëª©í‘œ: +2% (ì›”ë³„ í‰ê· )
â”œâ”€ í—ˆìš© ë²”ìœ„: +1% ~ +3%
â””â”€ ì´ˆê³¼ ì‹œ: ê±°ë˜ ì¤‘ë‹¨

Soft Target:
â”œâ”€ ëª©í‘œ: +2%
â”œâ”€ í—ˆìš© ë²”ìœ„: -2% ~ +5%
â””â”€ ë²”ìœ„ ë‚´: ê³„ì† ì§„í–‰
```

**Step 3: ì‹œì¥ ì¡°ê±´ë³„ ê±°ë˜ ì „ëµ**
```
â‘  ê°•ì„¸ì¥: ê±°ë˜ëŸ‰ 100%, ëª©í‘œ +3%
â‘¡ ì•½ì„¸ì¥: ê±°ë˜ëŸ‰ 50%, ëª©í‘œ +1%
â‘¢ ë³´í•©ì¥: ê±°ë˜ëŸ‰ 30%, ëª©í‘œ +0.5%
```

**Step 4: ì˜ˆìƒ ê°œì„  íš¨ê³¼**
```
ê°œì„  ì†Œìš” ì‹œê°„: 3ê°œì›”
ê°œì„  ë‚œì´ë„: ì¤‘ìƒ â­â­â­â­
ìš°ì„ ìˆœìœ„: 2ìˆœìœ„ ğŸŸ¡

ê°œì„  í›„:
â”œâ”€ CV: {cv:.2f} â†’ 0.7 (40% ê°œì„ )
â”œâ”€ ì›”ë³„ ë²”ìœ„: -15%~+20% â†’ -2%~+5%
â””â”€ íŒì •: ê°œì„  íš¨ê³¼ í¼
```
"""
    
    # ========== PART 3: ìµœì í™” íŒ ==========
    def _generate_optimization_tips(self) -> str:
        """ìµœì í™” íŒ ìƒì„±"""
        
        final_score = self.results['final_score']
        sharpe = final_score['scores'].get('í¬ì§€ì…˜ ìµœì í™”', 1.0)
        pf = 1.5  # ê¸°ë³¸ê°’
        
        tips = f"""

# PART 3ï¸âƒ£: ìµœì í™” íŒ

## ğŸš€ ì¶”ê°€ ìµœì í™” (ì´ë¯¸ í†µê³¼í•œ í•­ëª© ê°œì„ )

### Tip 1: Sharpe ë¹„ìœ¨ ê·¹ëŒ€í™” (í˜„ì¬ > 1.0)

```
ëª©í‘œ: Sharpe 1.0 â†’ 1.5 ì´ìƒ (50% ê°œì„ )

ë°©ë²•:
1ï¸âƒ£ í¬ì§€ì…˜ í¬ê¸° ìµœì í™”
   â”œâ”€ í˜„ì¬: ë™ì¼ í¬ê¸°
   â”œâ”€ ê°œì„ : ë³€ë™ì„± ê¸°ë°˜ ì¡°ì •
   â””â”€ íš¨ê³¼: ìˆ˜ìµ ì•ˆì •í™”

2ï¸âƒ£ ê±°ë˜ ì‹ í˜¸ ì •ì œ
   â”œâ”€ ì•½í•œ ì‹ í˜¸ í•„í„°ë§
   â”œâ”€ ê°•í•œ ì‹ í˜¸ë§Œ ì§„ì…
   â””â”€ íš¨ê³¼: ìŠ¹ë¥  í–¥ìƒ

3ï¸âƒ£ ì†ì‹¤ì œí•œ ê°•í™”
   â”œâ”€ ì¼ì¼ ì†ì‹¤ ì œí•œ: 2%
   â”œâ”€ ì£¼ê°„ ì†ì‹¤ ì œí•œ: 5%
   â””â”€ íš¨ê³¼: ìµœì•… ì†ì‹¤ ì œí•œ
```

### Tip 2: ìˆ˜ìµ íŒ©í„° (PF) í–¥ìƒ (í˜„ì¬ > {pf})

```
ëª©í‘œ: PF > 2.0 (33% ê°œì„ )

ë°©ë²•:
1ï¸âƒ£ í‰ê·  ìˆ˜ìµ ê±°ë˜ ì¦ê°€
   â”œâ”€ ìµì ˆ ê°€ê²© ìƒí–¥
   â”œâ”€ íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ í™œìš©
   â””â”€ íš¨ê³¼: ìˆ˜ìµ ê±°ë˜ í¬ê¸° ì¦ê°€

2ï¸âƒ£ í‰ê·  ì†ì‹¤ ê±°ë˜ ê°ì†Œ
   â”œâ”€ ì†ì ˆ ê°€ê²© í•˜í–¥
   â”œâ”€ ì‹ í˜¸ ê°•ë„ ìƒí–¥
   â””â”€ íš¨ê³¼: ì†ì‹¤ ê±°ë˜ ìµœì†Œí™”
```

### Tip 3: ë“œë¡œìš°ë‹¤ìš´ ì¶”ê°€ ê°œì„ 

```
ëª©í‘œ: ìµœëŒ€ ë“œë¡œìš°ë‹¤ìš´ -28% â†’ -15% (46% ê°œì„ )

ë°©ë²•:
1ï¸âƒ£ ë™ì  í¬ì§€ì…˜ ì‚¬ì´ì§•
2ï¸âƒ£ ì—°ì† ì†ì‹¤ ì œí•œ
3ï¸âƒ£ ìƒê´€ì„± í•„í„°
```
"""
        return tips
    
    # ========== PART 4: ì•¡ì…˜ í”Œëœ ==========
    def _generate_action_plan(self) -> str:
        """ì•¡ì…˜ í”Œëœ ìƒì„±"""
        
        disq = self.results['disqualification']
        failures = len(disq.get('reasons', []))
        
        if failures == 0:
            timeline = """3ê°œì›”: ì´ë¯¸ í†µê³¼ ìƒíƒœ
6ê°œì›”: ìµœì í™” ì§„í–‰
12ê°œì›”: ìë³¸ ë°°ê°€"""
        elif failures <= 2:
            timeline = """Week 1-2: ì‹ í˜¸ ê°•í™”
Week 3-4: ì†ì‹¤ì œí•œ ì„¤ì •
Month 1-3: ê¸°ë³¸ ê°œì„ 
Month 4-6: ì•ˆì •í™”
Month 7-12: ìµœì í™”"""
        else:
            timeline = """Week 1-2: ê¸´ê¸‰ ì§„ë‹¨
Week 3-4: ê¸°ë³¸ ê·œì¹™ ì„¤ì •
Month 1-3: ì§‘ì¤‘ ê°œì„ 
Month 4-6: ì¬ê²€ì¦
Month 7-12: ìµœì í™”"""
        
        plan = f"""

# PART 4ï¸âƒ£: ì‹¤ì „ ì•¡ì…˜ í”Œëœ

## ğŸ¯ ì¦‰ì‹œ ì‹¤í–‰ (ì´ë²ˆ ì£¼)

### Week 1-2: ì‹ í˜¸ ì •í™•ë„ ê°•í™”

**í•´ì•¼ í•  ì¼:**

```
â–¡ ì‹ í˜¸ ê°•ë„ ê¸°ì¤€ ì •ë¦½
  â”œâ”€ ì•½í•œ ì‹ í˜¸ (1~2ì ): ê±°ë˜ ê¸ˆì§€
  â”œâ”€ ì¤‘ê°„ ì‹ í˜¸ (3~4ì ): ì‹ ì¤‘í•˜ê²Œ
  â””â”€ ê°•í•œ ì‹ í˜¸ (5~7ì ): ì ê·¹ ì§„ì…

â–¡ ì›”ë³„ ê±°ë˜ ê¸°ë¡ ë¶„ì„
  â”œâ”€ ì†ì‹¤ ì›” í™•ì¸
  â”œâ”€ íŒ¨í„´ ë¶„ì„
  â””â”€ íŠ¹ì • ì›”ì—ë§Œ ì†ì‹¤?

â–¡ í˜„ì¬ ì‹ í˜¸ ì‹œìŠ¤í…œ ê²€í† 
  â”œâ”€ ì£¼ì§€í‘œë§Œ ì‚¬ìš©í•˜ê³  ìˆë‚˜?
  â”œâ”€ ë³´ì¡°ì§€í‘œ ê²€ì¦ ìˆëŠ”ê°€?
  â””â”€ ê°œì„ í•  ë¶€ë¶„ì€?
```

### Week 3-4: ì†ì‹¤ì œí•œ ê·œì¹™ ì„¤ì •

**í•´ì•¼ í•  ì¼:**

```
â–¡ ì›”ë³„ ì†ì‹¤ì œí•œ ê·œì¹™ ì •ì˜
â–¡ ê±°ë˜ í”Œë«í¼ì— ì•ŒëŒ ì„¤ì •
â–¡ í…ŒìŠ¤íŠ¸ ê±°ë˜ 1ì£¼ê°„ ì§„í–‰
â–¡ ë¬¸ì œì  ê¸°ë¡ ë° ì¡°ì •
```

## ğŸ“ˆ ë‹¨ê³„ë³„ íƒ€ì„ë¼ì¸

{timeline}

## ğŸ“Š ì›”ë³„ ëª©í‘œ

### Month 1: ê¸°ì´ˆ ë‹¤ì§€ê¸°
```
ëª©í‘œ ìˆ˜ìµ: +3~5%
ê±°ë˜ ìˆ˜: 28ê±´ (ì •ìƒ)
ìŠ¹ë¥ : 85~90%
íŒì •: ê°œì„  ì¤‘...
```

### Month 2-3: ì•ˆì •í™”
```
ëª©í‘œ ìˆ˜ìµ: +4~6%
ê±°ë˜ ìˆ˜: 28ê±´ (ì •ìƒ)
ìŠ¹ë¥ : 90~93%
íŒì •: ê°œì„  90% ì™„ë£Œ
```

### Month 4-6: ìµœì í™”
```
ëª©í‘œ ìˆ˜ìµ: +5~10%
ëˆ„ì : +30~50%
ìë³¸: $50 â†’ $65~$75
íŒì •: âœ… GO ë‹¬ì„±!
```

### Month 7-12: í™•ëŒ€
```
ëª©í‘œ ìˆ˜ìµ: +5~12%
ëˆ„ì : +50~100%
ìë³¸: $75 â†’ $100+
íŒì •: âœ… GO ìœ ì§€ + ìµœì í™”
```
"""
        return plan
    
    # ========== PART 5: ëª¨ë‹ˆí„°ë§ í…œí”Œë¦¿ ==========
    def _generate_monitoring_template(self) -> str:
        """ëª¨ë‹ˆí„°ë§ í…œí”Œë¦¿ ìƒì„±"""
        
        template = """

# PART 5ï¸âƒ£: ì£¼ê°„/ì›”ê°„ ëª¨ë‹ˆí„°ë§ ì²´í¬ë¦¬ìŠ¤íŠ¸

## ğŸ“‹ ì£¼ê°„ ëª¨ë‹ˆí„°ë§ í…œí”Œë¦¿ (Every Friday)

```
Week __ (____/__ ~ ____/__) ë¦¬í¬íŠ¸

ğŸ“Š ì„±ê³¼ ì§€í‘œ
â”Œâ”€ ì£¼ê°„ ìˆ˜ìµë¥ : ____% 
â”œâ”€ ê±°ë˜ ìˆ˜: ____ê±´
â”œâ”€ ìŠ¹ë¥ : ____% (ìŠ¹/ì´)
â”œâ”€ ìµœëŒ€ ìˆ˜ìµ: +____%
â”œâ”€ ìµœëŒ€ ì†ì‹¤: -____%
â””â”€ í˜„ì¬ ë“œë¡œìš°ë‹¤ìš´: -____%

ğŸ“ˆ ì‹ í˜¸ ë¶„ì„
â”Œâ”€ ê°•í•œ ì‹ í˜¸: ____ê±´ âœ…
â”œâ”€ ì¤‘ê°„ ì‹ í˜¸: ____ê±´ âš ï¸
â”œâ”€ ì•½í•œ ì‹ í˜¸: ____ê±´ âŒ
â””â”€ ì‹ í˜¸ ì •í™•ë„: ____%

âš ï¸ ìœ„í—˜ë„
â”Œâ”€ ì›” ëˆ„ì  ì†ì‹¤: -____%
â”œâ”€ ì†ì‹¤ì œí•œ ìƒíƒœ: Level __
â”œâ”€ ê¸´ê¸‰ ì†ì ˆ ì‘ë™: __íšŒ
â””â”€ ì£¼ì˜: _____________

âœ… ì²´í¬
â–¡ ì‹ í˜¸ ê¸°ì¤€ ì¤€ìˆ˜í–ˆëŠ”ê°€?
â–¡ ì†ì‹¤ì œí•œ ê·œì¹™ ì§€ì¼°ëŠ”ê°€?
â–¡ ê±°ë˜ ê¸°ë¡ ì •í™•í•œê°€?
â–¡ ê°œì„ ì‚¬í•­ ìˆëŠ”ê°€?

ğŸ“ ë‹¤ìŒ ì£¼ ê³„íš
â”€ ì ê²€í•  ë¶€ë¶„: __________
â”€ ê°œì„ í•  ë¶€ë¶„: __________
â”€ ëª©í‘œ: +___% ìˆ˜ìµ
```

## ğŸ“Š ì›”ê°„ ëª¨ë‹ˆí„°ë§ í…œí”Œë¦¿ (Every Month)

```
Month __ (20__/__) ì¢…í•© ë¦¬í¬íŠ¸

ğŸ“ˆ ì›”ë³„ ì„±ê³¼
â”Œâ”€ ì›”ê°„ ìˆ˜ìµë¥ : +___% âœ… / -___% âŒ
â”œâ”€ ê±°ë˜ ìˆ˜: ____ê±´
â”œâ”€ ìŠ¹ë¥ : ____%
â”œâ”€ ìˆ˜ìµ íŒ©í„°: ____
â””â”€ Sharpe ë¹„ìœ¨: ____

ğŸ’° ìë³¸ ë³€í™”
â”Œâ”€ ì‹œì‘ ìë³¸: $____
â”œâ”€ í˜„ì¬ ìë³¸: $____
â”œâ”€ ì›” ìˆ˜ìµ: $____
â””â”€ ëˆ„ì  ìˆ˜ìµ: $____ (+____%)

ğŸ¯ ëª©í‘œ ë‹¬ì„±ë„
â”Œâ”€ ëª©í‘œ ìˆ˜ìµë¥ : +___% 
â”œâ”€ ì‹¤ì œ ìˆ˜ìµë¥ : +___%
â””â”€ ë‹¬ì„±ë„: ____%

âš ï¸ Tier íŒì •
â”Œâ”€ ì†ì‹¤ ì›” ì—¬ë¶€: YES / NO
â”œâ”€ ì›”ë³„ í¸ì°¨: CV = ____
â”œâ”€ í˜„ì¬ Tier: Tier __ (0/1/2/3)
â””â”€ ìë™ë§¤ë§¤ íŒì •: âœ… GO / âŒ NO-GO

ğŸ“Š ìƒì„¸ ë¶„ì„
â”€ ìµœê³  ê±°ë˜: +___% (ì´ìœ : _______)
â”€ ìµœì•… ê±°ë˜: -___% (ì´ìœ : _______)
â”€ ê°•ì : ___________________
â”€ ì•½ì : ___________________

âœ… ê°œì„ ì‚¬í•­
â–¡ ì‹ í˜¸ ê°•í™” í•„ìš”: YES / NO
â–¡ ì†ì‹¤ì œí•œ ê°•í™” í•„ìš”: YES / NO
â–¡ ê¸°íƒ€: ________________

ğŸ“ ë‹¤ìŒ ë‹¬ ê³„íš
â”€ ëª©í‘œ ìˆ˜ìµë¥ : +___%
â”€ ì¤‘ì  ê°œì„ ì‚¬í•­: __________
```
"""
        return template
    
    # ========== ìµœì¢… ìš”ì•½ ==========
    def _generate_summary(self) -> str:
        """ìµœì¢… ìš”ì•½ ìƒì„±"""
        
        disq = self.results['disqualification']
        final_score = self.results['final_score']
        
        summary = f"""

# ê²°ë¡ 

## ğŸ¯ ë‹¹ì‹ ì˜ í˜„í™© ìš”ì•½

```
âœ… í˜„ì¬ ì„±ê³¼
â”œâ”€ ì´ ê±°ë˜: {disq['total_trades']}ê±´
â”œâ”€ ìŠ¹ë¥ : {disq['win_rate']:.1f}%
â”œâ”€ ìµœì¢… ì ìˆ˜: {final_score['final_score']:.1f}ì 
â”œâ”€ ë“œë¡œìš°ë‹¤ìš´: {disq['max_drawdown']:.1f}%
â”œâ”€ ë“±ê¸‰: {final_score['rating']}
â””â”€ íŒì •: {disq['status']}

âŒ ë¬¸ì œì 
"""
        
        if disq['reasons']:
            for reason in disq['reasons']:
                summary += f"â”œâ”€ {reason}\n"
        else:
            summary += "â””â”€ ë¬¸ì œ ì—†ìŒ! âœ…\n"
        
        summary += f"""

âœ… ê°œì„  ì „ëµ
â”œâ”€ ì‹ í˜¸ ê°•í™”: ì•½í•œ ì‹ í˜¸ ì œê±°
â”œâ”€ ì†ì‹¤ì œí•œ: ì›”ë³„ ì†ì‹¤ ì œí•œ ê·œì¹™ ì ìš©
â”œâ”€ ì›”ë³„ ì •ê·œí™”: ì›”ë³„ ìˆ˜ìµ ì•ˆì •í™”
â””â”€ ì†Œìš” ì‹œê°„: 3ê°œì›”

ğŸš€ ëª©í‘œ
â”œâ”€ 3ê°œì›” í›„: {'âœ… GO (ê°•ë ¥ ì¶”ì²œ)' if not disq['reasons'] else 'âš ï¸ GO (ì¡°ê±´ë¶€) ë‹¬ì„±'}
â”œâ”€ 6ê°œì›” í›„: âœ… GO (ê°•ë ¥ ì¶”ì²œ) ë‹¬ì„±
â””â”€ 12ê°œì›” í›„: ì—°ìˆ˜ìµë¥  40% ë‹¬ì„±
```

## ğŸ“Œ ì¦‰ì‹œ ì‹¤í–‰ ìˆœì„œ

**Week 1-2:**
```
1ï¸âƒ£ ì‹ í˜¸ ê°•ë„ ê¸°ì¤€ ì •ë¦½ (í•„ìˆ˜)
2ï¸âƒ£ ì›”ë³„ ê±°ë˜ ê¸°ë¡ ë¶„ì„ (í•„ìˆ˜)
3ï¸âƒ£ í˜„ì¬ ì‹ í˜¸ ì‹œìŠ¤í…œ ê²€í†  (í•„ìˆ˜)
```

**Week 3-4:**
```
4ï¸âƒ£ ì›”ë³„ ì†ì‹¤ì œí•œ ê·œì¹™ ì„¤ì • (í•„ìˆ˜)
5ï¸âƒ£ ê±°ë˜ í”Œë«í¼ ì„¤ì • (í•„ìˆ˜)
6ï¸âƒ£ í…ŒìŠ¤íŠ¸ ê±°ë˜ ì‹œì‘ (í•„ìˆ˜)
```

**Month 1:**
```
7ï¸âƒ£ ì›”ë³„ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (í•„ìˆ˜)
8ï¸âƒ£ ê°œì„ ì‚¬í•­ ê¸°ë¡ (í•„ìˆ˜)
9ï¸âƒ£ ì¡°ì • ë° ìµœì í™” (í•„ìˆ˜)
```

## ğŸ’ª ì„±ê³µì„ ìœ„í•œ ë§ˆì§€ë§‰ ì¡°ì–¸

```
âœ… ë°˜ë“œì‹œ ì§€í‚¬ ê²ƒ
â”œâ”€ ì‹ í˜¸ ê¸°ì¤€ ì—„ê²©í•˜ê²Œ ì§€í‚¤ê¸°
â”œâ”€ ì†ì‹¤ì œí•œ ê·œì¹™ ì¤€ìˆ˜í•˜ê¸°
â”œâ”€ ì›”ê°„ ëª¨ë‹ˆí„°ë§ ê¼­ í•˜ê¸°
â”œâ”€ ê±°ë˜ ê¸°ë¡ ì •í™•íˆ ë‚¨ê¸°ê¸°
â””â”€ ê°œì„ ì‚¬í•­ ì¦‰ì‹œ ë°˜ì˜í•˜ê¸°

âŒ ì ˆëŒ€ í•˜ë©´ ì•ˆ ë  ê²ƒ
â”œâ”€ ì•½í•œ ì‹ í˜¸ë¡œ ë¬´ì‘ì • ê±°ë˜
â”œâ”€ ì†ì‹¤ì œí•œ ê·œì¹™ ë¬´ì‹œ
â”œâ”€ ëª¨ë‹ˆí„°ë§ ê±´ë„ˆë›°ê¸°
â”œâ”€ ê±°ë˜ ê¸°ë¡ ëŒ€ì¶© í•˜ê¸°
â””â”€ ê°ì •ì  íŒë‹¨ (ë‘ë ¤ì›€, ìš•ì‹¬)

ğŸ’ª ë‹¹ì‹ ì€ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
â””â”€ í˜„ì¬ ê¸°ì´ˆëŠ” ê°•í•¨ ({disq['win_rate']:.1f}% ìŠ¹ë¥ )
â””â”€ ê°œì„ ì ë§Œ ëª…í™• (ì›”ë³„ ì•ˆì •í™”)
â””â”€ 3ê°œì›”ì´ë©´ ì¶©ë¶„íˆ ê°œì„  ê°€ëŠ¥!
â””â”€ 12ê°œì›” í›„ ì—°ìˆ˜ìµë¥  40% ë‹¬ì„± ê°€ëŠ¥!
```

---

**ìµœì¢… íŒì •:**

```
í˜„ì¬: {disq['status']} ({disq['tier']})
     â””â”€ ì´ìœ : {', '.join(disq['reasons'][:2]) if disq['reasons'] else 'ë¬¸ì œ ì—†ìŒ'}

3ê°œì›” í›„: âš ï¸ GO (ì¡°ê±´ë¶€) ë˜ëŠ” âœ… GO (ê°•ë ¥ ì¶”ì²œ)
         â””â”€ ê°œì„  ì¤‘...

6ê°œì›” í›„: âœ… GO (ê°•ë ¥ ì¶”ì²œ)
         â””â”€ ìë™ë§¤ë§¤ ì‹œì‘!

12ê°œì›” í›„: âœ… GO + ì—°ìˆ˜ìµë¥  40%
          â””â”€ ì™„ì „ ì„±ê³µ!
```

---

**ë‹¹ì‹ ì˜ ì„±ê³µì„ ì‘ì›í•©ë‹ˆë‹¤!** ğŸ’ªğŸš€

---

**ë¦¬í¬íŠ¸ ìƒì„±ì¼:** {datetime.now().strftime("%Yë…„ %mì›” %dì¼ %H:%M:%S")}  
**ë©”ë‰´ì–¼ ë²„ì „:** 2.0 (í•˜ì´ë¸Œë¦¬ë“œ ì‹¤ì „í˜•)  
**ì €ì:** Phoenix Strategy Team  
**ëª©í‘œ:** ìŠ¹ë¥  80%, ì—°ìˆ˜ìµë¥  40% ë‹¬ì„±
"""
        
        return summary
    
    # ========== ìµœì¢… ë¦¬í¬íŠ¸ ìƒì„± ==========
    def generate_full_report(self) -> str:
        """ì „ì²´ ë¦¬í¬íŠ¸ ìƒì„±"""
        
        report = "# ğŸ“š Phoenix Strategy Analyzer\n"
        report += "## 16ê°œ ê²€ì¦ ì‹œìŠ¤í…œ ìë™ ë¶„ì„ ë¦¬í¬íŠ¸\n\n"
        report += f"**ìƒì„±ì¼:** {datetime.now().strftime('%Yë…„ %mì›” %dì¼ %H:%M:%S')}\n\n"
        report += "---\n\n"
        
        # PART 1
        report += self._generate_checklist()
        report += "\n\n---\n\n"
        
        # PART 2
        report += self._generate_failure_analysis()
        report += "\n\n---\n\n"
        
        # PART 3
        report += self._generate_optimization_tips()
        report += "\n\n---\n\n"
        
        # PART 4
        report += self._generate_action_plan()
        report += "\n\n---\n\n"
        
        # PART 5
        report += self._generate_monitoring_template()
        report += "\n\n---\n\n"
        
        # ìµœì¢… ìš”ì•½
        report += self._generate_summary()
        
        return report
    
    def save_report(self, output_path: str = "/mnt/user-data/outputs/") -> str:
        """ë¦¬í¬íŠ¸ë¥¼ íŒŒì¼ë¡œ ì €ì¥"""
        
        full_report = self.generate_full_report()
        filepath = os.path.join(output_path, self.filename)
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(full_report)
        
        return filepath, full_report


# ========== Streamlit í†µí•© í•¨ìˆ˜ ==========
def generate_and_display_report(comprehensive_results: Dict[str, Any], 
                                trades_df: pd.DataFrame,
                                st) -> tuple:
    """
    Streamlitì—ì„œ ì‚¬ìš©í•  ë¦¬í¬íŠ¸ ìƒì„± ë° í‘œì‹œ í•¨ìˆ˜
    
    Parameters:
    -----------
    comprehensive_results : dict
        16ê°œ ê²€ì¦ ê²°ê³¼
    trades_df : pd.DataFrame
        ê±°ë˜ ë°ì´í„°
    st : streamlit
        Streamlit ëª¨ë“ˆ
    
    Returns:
    --------
    tuple
        (íŒŒì¼ê²½ë¡œ, ë¦¬í¬íŠ¸ ë‚´ìš©)
    """
    
    generator = AnalysisReportGenerator(comprehensive_results, trades_df)
    filepath, full_report = generator.save_report()
    
    # Streamlitì—ì„œ í‘œì‹œ
    st.markdown("## ğŸ“Š ë¶„ì„ ê²°ê³¼ ë¦¬í¬íŠ¸")
    
    # ìµœì¢… íŒì •
    disq = comprehensive_results['disqualification']
    final_score = comprehensive_results['final_score']
    
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("ìµœì¢… ì ìˆ˜", f"{final_score['final_score']:.1f}ì ", f"{final_score['rating']}")
    with col2:
        st.metric("ìŠ¹ë¥ ", f"{disq['win_rate']:.1f}%", f"{disq['total_trades']}ê±´")
    with col3:
        st.metric("ìµœëŒ€ ë“œë¡œìš°ë‹¤ìš´", f"{disq['max_drawdown']:.1f}%", "ìœ„í—˜ë„")
    with col4:
        st.metric("íŒì •", disq['status'], disq['tier'])
    
    # íƒˆë½ ì´ìœ 
    if disq['reasons']:
        st.warning(f"### âš ï¸ ê°œì„  í•„ìš” ì‚¬í•­ ({len(disq['reasons'])}ê°œ)")
        for i, reason in enumerate(disq['reasons'], 1):
            st.write(f"**{i}. {reason}**")
    else:
        st.success("### âœ… ëª¨ë“  ê²€ì¦ í†µê³¼!")
    
    # ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
    st.success(f"âœ… ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: {generator.filename}")
    
    with st.expander("ğŸ“„ ì „ì²´ ë¦¬í¬íŠ¸ ë³´ê¸°"):
        st.markdown(full_report)
    
    return filepath, full_report


if __name__ == "__main__":
    print("ë¶„ì„ ë¦¬í¬íŠ¸ ìƒì„±ê¸°ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.")
    print("streamlitì—ì„œ generate_and_display_report() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”.")